# Система Управления Миссией

## Обзор

Эта система управления миссией предназначена для управления полетами дрона, включая инициализацию, аутентификацию, навигацию по путевым точкам и сброс груза. Система обеспечивает готовность всех модулей перед началом миссии и непрерывно взаимодействует с сервером для обновления статуса миссии и получения необходимых разрешений на критические действия, такие как взвод дрона и сброс груза.

### Библиотеки

- **cmath**: Предоставляет математические функции.
- **cstdio**: Включает функции для ввода и вывода.
- **cstring**: Содержит функции для работы с C-строками.
- **cstdlib**: Включает общие утилиты, такие как управление памятью, генерация случайных чисел и системные команды.
- **unistd.h**: Предоставляет доступ к API операционной системы POSIX.
- **ctime**: Содержит функции для работы с датой и временем.
- **algorithm**: Предоставляет коллекцию алгоритмов для выполнения операций с контейнерами.

## Константы

- `RETRY_DELAY_SEC`: Время задержки в секундах для повторных попыток неудачных операций.
- `RETRY_REQUEST_DELAY_SEC`: Время задержки в секундах для повторных запросов миссии.
- `FLY_ACCEPT_PERIOD_US`: Период приема полета в микросекундах.
- `EARTH_RADIUS`: Радиус Земли в метрах для расчетов координат.

## Внешние переменные

- `uint32_t commandNum`: Количество команд в миссии.
- `MissionCommand* commands`: Указатель на массив команд миссии.

## Функции

### Координаты и навигация

- **getPosition**: Преобразует широту, долготу и высоту в декартовы координаты.
- **distance3D**: Вычисляет 3D расстояние между двумя точками.
- **calcDeviations**: Вычисляет горизонтальные и вертикальные отклонения от текущего положения до отрезка линии.
- **getCoords**: Получает текущие координаты дрона.
- **changeWaypoint**: Изменяет текущую путевую точку дрона.

### Управление миссией

- **getNextWayPoint**: Находит следующую путевую точку в миссии.
- **changeSpeed**: Изменяет скорость дрона.
- **waitForArmRequest**: Ожидает запроса на взвод от автопилота.
- **permitArm**: Разрешает взвод дрона.
- **forbidArm**: Запрещает взвод дрона.
- **setKillSwitch**: Включает или отключает двигатели дрона.
- **setCargoLock**: Управляет замком груза для сброса груза.

## Логика работы

### Инициализация

Программа начинает с проверки готовности всех модулей. Используются функции **waitForInit** для проверки состояния следующих модулей:

- Periphery Controller
- Autopilot Connector
- Navigation System
- Server Connector
- Credential Manager

Если какой-либо модуль не готов, программа повторяет попытку с задержкой, определенной в `RETRY_DELAY_SEC`.

### Аутентификация

После инициализации всех модулей система проходит аутентификацию на сервере ORVD с использованием функции **sendSignedMessage** и метода `/api/auth`.

### Получение миссии

Система постоянно запрашивает сервер для получения миссии, используя **sendSignedMessage** с методом `/api/fmission_kos`. После успешного получения миссии она проверяется на корректность с помощью **parseMission**.

### Ожидание запроса на взвод

Система переходит в режим ожидания запроса на взвод от автопилота, используя функцию **waitForArmRequest**. После получения запроса система отправляет запрос на сервер для получения разрешения на взвод.

### Навигация и выполнение миссии

Дрон выполняет миссию, следуя путевым точкам, заданным в миссии. Система постоянно получает текущие координаты дрона, вычисляет расстояние до текущей путевой точки и отклонение от маршрута. При необходимости дрон корректирует курс и высоту.

### Сброс груза

Система проверяет, достиг ли дрон путевой точки, где необходимо сбросить груз. Если да, она активирует механизм сброса груза.

### Завершение миссии

После выполнения всех команд миссии система завершает выполнение и отключает двигатели дрона.

## Выводы и сообщения

Программа использует функции `fprintf` для вывода сообщений о состоянии системы, таких как:

- Готовность модулей
- Состояние аутентификации
- Получение и проверка миссии
- Ожидание и получение запроса на взвод
- Изменение координат и высоты
- Достижение путевых точек
- Сброс груза
- Завершение миссии

Сообщения выводятся в стандартный поток ошибок (stderr) с указанием имени сущности (ENTITY_NAME) и подробной информацией о текущем состоянии.

Пример вывода сообщений:

```cpp
fprintf(stderr, "[%s] Warning: Failed to receive initialization notification from Periphery Controller. Trying again in %ds\n", ENTITY_NAME, RETRY_DELAY_SEC);
fprintf(stderr, "[%s] Info: Successfully authenticated on the server\n", ENTITY_NAME);
fprintf(stderr, "[%s] Info: Ready to arm\n", ENTITY_NAME);
fprintf(stderr, "[%s] Info: Heading to waypoint %u at (%.2f, %.2f, %.2f)\n", ENTITY_NAME, curWaypoint, points[curWaypoint].x, points[curWaypoint].y, points[curWaypoint].z);
fprintf(stderr, "[%s] Info: Waypoint %u reached!!!\n", ENTITY_NAME, curWaypoint);
fprintf(stderr, "[%s] Mission completed. Total distance: %.2f meters, Total time: %.2f seconds\n", ENTITY_NAME, totalDistance, totalTime);
```

Эти сообщения помогают отслеживать выполнение миссии и диагностировать возможные проблемы в реальном времени.